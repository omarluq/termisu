name: E2E Tests
on:
  push:
    branches: [main]
    paths:
      - "src/**/*.cr"
      - "examples/**/*.cr"
      - "e2e/**"
      - ".github/workflows/e2e.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  # Build binaries once per OS and Crystal version
  build:
    name: Build (${{ matrix.os }}, Crystal ${{ matrix.crystal }})
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        crystal: ["1.18.2", "1.19.1"]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Crystal
        uses: ./.github/actions/setup-crystal
        with:
          crystal-version: ${{ matrix.crystal }}
      - name: Build and upload binaries
        uses: ./.github/actions/build-e2e-binaries
        with:
          artifact-name: e2e-binaries-${{ matrix.os == 'ubuntu-latest' && 'linux' || 'macos' }}-${{ matrix.crystal }}
  e2e:
    name: E2E (${{ matrix.os }}, ${{ matrix.shell }}, Crystal ${{ matrix.crystal }})
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        shell: [bash, zsh, fish]
        crystal: ["1.18.2", "1.19.1"]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Download binaries
        uses: actions/download-artifact@v8
        with:
          name: e2e-binaries-${{ matrix.os == 'ubuntu-latest' && 'linux' || 'macos' }}-${{ matrix.crystal }}
          path: bin/
      - name: Make binaries executable
        run: chmod +x bin/*
      - name: Install zsh (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.shell == 'zsh'
        run: sudo apt-get update && sudo apt-get install -y zsh
      - name: Install fish (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.shell == 'fish'
        run: |
          sudo apt-add-repository -y ppa:fish-shell/release-3
          sudo apt-get update
          sudo apt-get install -y fish
      - name: Setup Node.js with pnpm
        uses: ./.github/actions/setup-node-pnpm
      - name: Run E2E tests
        working-directory: e2e
        env:
          TUI_TEST_SHELL: ${{ matrix.shell }}
        run: pnpm test
      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v7
        with:
          name: tui-traces-${{ matrix.os }}-${{ matrix.shell }}
          path: e2e/tui-traces/
          retention-days: 7
      - name: Upload snapshots on failure
        if: failure()
        uses: actions/upload-artifact@v7
        with:
          name: snapshots-${{ matrix.os }}-${{ matrix.shell }}
          path: e2e/tests/__snapshots__/
          retention-days: 7
